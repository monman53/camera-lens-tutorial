<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9ZG1KHTVT"></script>
<script src='/scripts/google.js'></script>

<title>Camera Lens Tutorial</title>

<div id="app">
    <canvas id="canvas" @mousedown="mouseDown" @mousemove="mouseMove" @mouseup="mouseUp"></canvas>
    <div>
        <label>
            Lens thickness
            <input type="range" min="0.1" :max="Math.min(5, lens.r*2)" step="0.1" v-model="lens.d">
            {{lens.d}}
        </label>
        <br>
        <label>
            Lens R
            <input type="range" :min="lens.d/2" max="100" step="0.1" v-model="lens.r">
            {{lens.r}}
        </label>
        <br>
        <label>
            Number of rays
            <input type="range" min="1" max="1000" stp="1" v-model="rayN">
            {{rayN}}
        </label>
        <br>
        <label v-for="light in lights">
            <input type="checkbox" v-model="light.enabled">
            Show light {{light.color}}
            <br>
        </label>
    </div>
    <div>
        <details>
            <summary>Debug</summary>
            moving: {{moving}}
            FPS: {{fps}}<br>
        </details>
    </div>

    <h1>Description</h1>
</div>

<script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
        data() {
            return {
                canvas: undefined,
                cx: 0,
                cy: 0,
                scale: 50,
                rayN: 360,
                lens: {
                    r: 10,
                    d: 0.3,
                    n: 1.5,
                },
                lights: [
                    { x: -9, y: -3, r: 0.1, color: "cyan", enabled: true },
                    { x: -11, y: -3, r: 0.1, color: "yellow", enabled: false },
                    { x: -13, y: -3, r: 0.1, color: "magenta", enabled: false },
                ],
                moving: -1,
                fps: 0,
            }
        },
        methods: {
            mouseDown(e) {
                const rect = this.canvas.getBoundingClientRect()
                const x = (e.clientX - rect.left - this.cx) / this.scale;
                const y = (e.clientY - rect.top - this.cy) / this.scale;

                this.lights.forEach((light, idx) => {
                    if (Math.pow(x - light.x, 2) + Math.pow(y - light.y, 2) < Math.pow(light.r * 2, 2)) {
                        this.moving = idx;
                    }
                });
            },
            mouseMove(e) {
                if (this.moving >= 0) {
                    const rect = this.canvas.getBoundingClientRect()
                    const x = (e.clientX - rect.left - this.cx) / this.scale;
                    const y = (e.clientY - rect.top - this.cy) / this.scale;
                    this.lights[this.moving].x = Math.min(x, -this.focalLength * 1.001);
                    this.lights[this.moving].y = y;
                }
            },
            mouseUp(e) {
                this.moving = -1;
            },
        },
        computed: {
            focalLength() {
                return this.lens.r / 2 * (this.lens.n - 1);
            },
            lensSize() {
                const theta = Math.acos((this.lens.r - this.lens.d / 2) / this.lens.r);
                return this.lens.r * Math.sin(theta);
            },
        },
        mounted() {
            //--------------------------------
            // Canvas setup
            //--------------------------------
            this.canvas = document.getElementById("canvas");
            canvas.height = 800;
            canvas.width = 1600;
            const ctx = canvas.getContext("2d");

            // Render callback
            let frames = 0;
            let startTime = new Date().getTime();
            const render = () => {
                // Calculate FPS
                frames += 1;
                let endTime = new Date().getTime();
                if (endTime - startTime >= 1000) {
                    this.fps = frames / (endTime - startTime) * 1000;
                    startTime = endTime;
                    frames = 0;
                }

                //================================
                // Canvas drawing
                //================================
                const w = canvas.width;
                const h = canvas.height;
                this.cx = canvas.width * 2 / 3;
                this.cy = canvas.height / 2;

                //--------------------------------
                // Clear canvas
                //--------------------------------
                ctx.reset();
                // ctx.clearRect(0, 0, w, h);

                //--------------------------------
                // Background
                //--------------------------------
                ctx.fillRect(0, 0, w, h);

                //--------------------------------
                // Axes
                //--------------------------------
                ctx.strokeStyle = "white";
                ctx.lineWidth = 0.2;
                // x-axis
                ctx.beginPath();
                ctx.moveTo(0, this.cy);
                ctx.lineTo(w, this.cy);
                ctx.stroke();

                // y-axis
                ctx.beginPath();
                ctx.moveTo(this.cx, 0);
                ctx.lineTo(this.cx, h);
                ctx.stroke();

                //--------------------------------
                // Lights
                //--------------------------------
                this.lights.forEach((light) => {
                    if (!light.enabled) {
                        return;
                    }


                    // Source
                    {
                        const x = this.cx + light.x * this.scale;
                        const y = this.cy + light.y * this.scale;
                        const color = light.color;
                        ctx.strokeStyle = color;

                        // Rays
                        ctx.lineWidth = 0.3;
                        for (let i = 0; i < this.rayN; i++) {
                            const theta = 2 * Math.PI * i / this.rayN;
                            let r = w + h; // Rough length

                            const r0 = - light.x / Math.cos(theta);
                            const y0 = light.y + r0 * Math.sin(theta);
                            const hitLens = r0 > 0 && -this.lensSize < y0 && y0 < this.lensSize;
                            if (hitLens) {
                                r = r0 * this.scale;
                            }
                            const tx = x + r * Math.cos(theta);
                            const ty = y + r * Math.sin(theta);

                            ctx.beginPath();
                            ctx.moveTo(x, y);
                            ctx.lineTo(tx, ty);
                            ctx.stroke();

                            // Ray behind lens
                            if (hitLens) {
                                const s1 = Math.abs(light.x);
                                const s2 = this.focalLength + this.focalLength * this.focalLength / (s1 - this.focalLength);
                                const ux = s2;
                                const uy = - light.y * (s2 / s1)
                                const theta = Math.atan2(uy - y0, ux - 0);
                                const r = w + h;
                                ctx.beginPath();
                                ctx.moveTo(tx, ty);
                                ctx.lineTo(tx + r * Math.cos(theta), ty + r * Math.sin(theta));
                                ctx.stroke();
                            }
                        }

                        // Point
                        const r = light.r * this.scale;
                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = "black";
                        ctx.stroke();
                    }

                    // Image (circle)
                    // {
                    //     const s1 = Math.abs(light.x);
                    //     const s2 = this.focalLength + this.focalLength * this.focalLength / (s1 - this.focalLength);
                    //     const x = cx + s2 * this.scale;
                    //     const y = cy - light.y * (s2 / s1) * this.scale;
                    //     const color = light.color;
                    //     ctx.strokeStyle = color;

                    //     const r = light.r * this.scale;
                    //     ctx.beginPath();
                    //     ctx.arc(x, y, r, 0, Math.PI * 2);
                    //     ctx.fillStyle = color;
                    //     ctx.fill();
                    //     ctx.lineWidth = 1;
                    //     ctx.strokeStyle = "black";
                    //     ctx.stroke();
                    // }
                });

                //--------------------------------
                // Lens
                //--------------------------------
                {
                    const r = this.lens.r * this.scale;
                    const theta = Math.acos((this.lens.r - this.lens.d / 2) / this.lens.r);
                    const y = this.cy;
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "white";
                    // Left
                    {
                        const x = this.cx + (this.lens.r - this.lens.d / 2) * this.scale;
                        const startAngle = Math.PI - theta;
                        const endAngle = Math.PI + theta;
                        ctx.beginPath();
                        ctx.arc(x, y, r, startAngle, endAngle);
                        ctx.stroke();
                    }
                    // Right
                    {
                        const x = this.cx - (this.lens.r - this.lens.d / 2) * this.scale;
                        const startAngle = - theta;
                        const endAngle = theta;
                        ctx.beginPath();
                        ctx.arc(x, y, r, startAngle, endAngle);
                        ctx.stroke();
                    }
                }
                // Focal point
                {
                    const r = 3;
                    const y = this.cy;
                    ctx.fillStyle = "white";
                    ctx.strokeStyle = "white";
                    // Left
                    {
                        const x = this.cx - this.focalLength * this.scale;
                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                    }
                    // Right
                    {
                        const x = this.cx + this.focalLength * this.scale;
                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                    }
                }



                // Next frame
                requestAnimationFrame(render);
            }

            // Rendering bootstrap
            requestAnimationFrame(render);
        },
    }).mount('#app')
</script>